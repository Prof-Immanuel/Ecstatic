{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apply for a Loan - Ecstatic</title>
  <link rel="stylesheet" href="{% static 'loan_application.css' %}">
</head>
<body>
  <div class="loan-section">
    <div class="loan-container">
      <h2>Loan Application</h2>
      {% if messages %}
    <div class="alert-container">
        {% for message in messages %}
        {% if "apply_loan" in message.tags %}
            <div class="alert {{ message.tags }}">
                {{ message }}
            </div>
        {% endif %}
        {% endfor %}
    </div>
{% endif %}

      <form action="{% url 'apply_loan' %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <label for="amount">Loan Amount</label>
        <input type="number" step="0.01" id="amount" name="amount" required placeholder="Enter the loan amount">

        <label for="loan-reason">Reason for Loan</label>
        <textarea id="loan-reason" name="loan_reason" required placeholder="Enter the reason for applying"></textarea>
        
        <label for="collateral">Collateral</label>
        <input type="text" id="collateral" name="collateral" required placeholder="Enter your collateral">

        <label for="location">Location</label>
        <input type="text" id="location" name="location" required placeholder="Enter your location">

        <label for="repayment-duration">Repayment Duration</label>
        <select id="repayment-duration" name="repayment_duration" required>
            <option value="1week">1 week - 15% interest</option>
            <option value="2weeks">2 weeks - 20% interest</option>
            <option value="3weeks">3 weeks - 30% interest</option>
            <option value="4weeks">4 weeks - 40% interest</option>
        </select>

        <label for="estimated_income">Estimated Monthly Income (ZMW):</label>
        <input type="number" step="0.01" name="estimated_income" required>


        <label for="phone-number">Phone Number</label>
        <input type="text" id="phone-number" name="phone_number" required placeholder="Enter your Phone number">


        <label for="nrc-number">NRC Number</label>
        <input type="text" id="nrc-number" name="nrc_number" required placeholder="Enter your NRC number">


        <label for="nrc-photo">Upload NRC Photo</label>
        <input type="file" id="nrc-photo" name="nrc_photo" accept="image/*" required>


        <button type="submit">Submit Loan Application</button>
      </form>

    
      <p class="info-text">
        Note: Loan applications are subject to approval. You will be notified via phone once your application is reviewed.
      </p>
    </div>
  </div>
  <script>
    function compressImage(file, quality = 0.7, maxWidth = 800) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
    
            // Resize image while maintaining aspect ratio
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
    
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    
            // Compress image to desired quality
            canvas.toBlob(
              (blob) => {
                if (blob) resolve(blob);
                else reject(new Error('Compression failed.'));
              },
              'image/jpeg', // Output format
              quality // Compression quality (0.0 - 1.0)
            );
          };
          img.src = event.target.result;
        };
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
      });
    }
    
    // Usage Example
    document.getElementById('nrc-photo').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        try {
          const compressedBlob = await compressImage(file);
          const compressedFile = new File([compressedBlob], file.name, { type: 'image/jpeg' });
    
          // Now you can upload `compressedFile` to your server
          console.log('Compressed file:', compressedFile);
        } catch (error) {
          console.error('Error compressing image:', error);
        }
      }
    });
    
  </script>
</body>
</html>
